const { faker } = require('@faker-js/faker');
const User = require('../models/userModel.js');
const Post = require('../models/postModel.js');
const Reaction = require('../models/reactionModel.js');

const generateUsersAndPosts = async (userCount, postCount, reactionCount) => {
    for (let i = 0; i < userCount; i++) {
        const user = {
            username: faker.internet.userName(),
            first_name: faker.name.firstName(),
            last_name: faker.name.lastName(),
            email: faker.internet.email(),
        };
  
        const createdUser = await User.query().insert(user);

        for (let j = 0; j < postCount; j++) {
            const post = {
                content: faker.lorem.sentence(3),
                user_id: createdUser.id,
            };

            const createdPost = await Post.query().insert(post);

            const uniquePairs = [];
            for (let k = 1; k <= userCount; k++) {
                if (k !== createdUser.id) {
                    uniquePairs.push([k, createdPost.id]);
                }
            }

            const selectedPairs = faker.helpers.shuffle(uniquePairs).slice(0, reactionCount);
            for (const [user_id, post_id] of selectedPairs) {
                const reaction = {
                    user_id: user_id,
                    post_id: post_id,
                    type: ['LIKE', 'DISLIKE'][Math.floor(Math.random() * 2)],
                };

                const existingReaction = await Reaction.query().findOne(reaction);

                if (!existingReaction) {
                    await Reaction.query().insert(reaction);
                }
            }
        }
    };
};

const runGeneration = async (countUsers, countPostsForUser, countReactionForPost) => {
    const userCount = await User.query().count('id as count').first();
    if (userCount.count >= 1000) {
      console.log('Generation not launched. There are already more than 1000 users in the database.');
      return;
    }
    await generateUsersAndPosts(countUsers, countPostsForUser, countReactionForPost);
    console.log('Generation completed.');
  };
  
  module.exports = {
    generateUsersAndPosts,
  };